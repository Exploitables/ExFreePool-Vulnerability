#include "subsystem.h"

NTSTATUS PoolDriverUnload(PDRIVER_OBJECT pDriverObject)
{
	IoDeleteSymbolicLink(&gDos);
	if (pDriverObject)
	{
		IoDeleteDevice(pDriverObject->DeviceObject);
	}

	DbgPrint("%s ***********************\n", PREFIX);
	DbgPrint("%s ExFreePool Vulnerable Driver Uninitialized.\n", PREFIX);
	DbgPrint("%s ***********************\n", PREFIX);

	return STATUS_SUCCESS;
}

NTSTATUS PoolDriverCreateCloseIrp(PDEVICE_OBJECT pDeviceObject, PIRP Irp)
{
	UNREFERENCED_PARAMETER(pDeviceObject);

	if (Irp)
	{
		Irp->IoStatus.Status = STATUS_SUCCESS;
		Irp->IoStatus.Information = 0;

		IoCompleteRequest(Irp, IO_NO_INCREMENT);
		return STATUS_SUCCESS;
	}

	return STATUS_INVALID_PARAMETER;
}

NTSTATUS PoolDriverDeviceIOControl(PDEVICE_OBJECT pDeviceObject, PIRP Irp)
{
	UNREFERENCED_PARAMETER(pDeviceObject);

	NTSTATUS Status = STATUS_INVALID_PARAMETER;
	PIO_STACK_LOCATION IO = IoGetCurrentIrpStackLocation(Irp);

	if (Irp && IO)
	{
		switch (IO->Parameters.DeviceIoControl.IoControlCode)
		{
		case IOCTL_FREE_POOL:
		{
			DbgPrint("%s ***********************\n", PREFIX);
			DbgPrint("%s ExFreePool Primitive Entry.\n", PREFIX);
			Status = PoolDriverPrimitiveSetup(Irp, IO);
			break;
		}
		}

		Irp->IoStatus.Status = Status;
		Irp->IoStatus.Information = 0;

		IoCompleteRequest(Irp, IO_NO_INCREMENT);
	}

	return Status;
}

NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRegistryPath)
{
	UNREFERENCED_PARAMETER(pRegistryPath);

	RtlInitUnicodeString(&gDev, L"\\Device\\ExFreePoolPrimitive");
	RtlInitUnicodeString(&gDos, L"\\DosDevices\\ExFreePoolPrimitive");

	if (pDriverObject)
	{
		IoCreateDevice(pDriverObject, 0, &gDev, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &pgDeviceObject);
		IoCreateSymbolicLink(&gDos, &gDev);

		pDriverObject->MajorFunction[IRP_MJ_CREATE] = PoolDriverCreateCloseIrp;
		pDriverObject->MajorFunction[IRP_MJ_CLOSE] = PoolDriverCreateCloseIrp;
		pDriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = PoolDriverDeviceIOControl;
		pDriverObject->DriverUnload = PoolDriverUnload;
	}

	if (pgDeviceObject)
	{
		pgDeviceObject->Flags |= DO_DIRECT_IO;
		pgDeviceObject->Flags &= DO_DEVICE_INITIALIZING;
	}

	DbgPrint("%s ***********************\n", PREFIX);
	DbgPrint("%s", BANNER);
	DbgPrint("%s ExFreePool Vulnerable Driver Initialized.\n", PREFIX);
	DbgPrint("%s ***********************\n", PREFIX);

	return STATUS_SUCCESS;
}