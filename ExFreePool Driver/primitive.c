// Utilized HackSys Extreme Vulnerable Driver for assistance.
// Link: https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/BufferOverflowStack.c

#include "subsystem.h"

NTSTATUS PoolDriverFreePoolPrimitive(PVOID UserBuffer)
{
    NTSTATUS Status = STATUS_SUCCESS;
    unsigned long* Address;

    __try
    {
        Address = *(unsigned long*)UserBuffer;
        DbgPrint("%s User-provided Pool Address: 0x%p\n", PREFIX, (unsigned long*)Address);

        DbgPrint("%s Freeing The Pool...\n", PREFIX);
        ExFreePoolWithTag((PVOID)Address, 0);
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        Status = GetExceptionCode();
        DbgPrint("%s Exception Thrown! NTSTATUS: %d (0x%x)\n", PREFIX, Status, Status);
    }

    return Status;
}

NTSTATUS PoolDriverPrimitiveSetup(PIRP Irp, PIO_STACK_LOCATION IO)
{
    UNREFERENCED_PARAMETER(Irp);

    PVOID UserBuffer = 0;
    NTSTATUS Status = STATUS_INVALID_PARAMETER;

    UserBuffer = IO->Parameters.DeviceIoControl.Type3InputBuffer;

    if (UserBuffer)
    {
        Status = PoolDriverFreePoolPrimitive(UserBuffer);
    }

    DbgPrint("%s Return NTSTATUS: %d (0x%x)\n", PREFIX, Status, Status);
    DbgPrint("%s ***********************\n", PREFIX);

    return Status;
}