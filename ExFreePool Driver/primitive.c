// Utilized HackSys Extreme Vulnerable Driver for assistance.
// Link: https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/BufferOverflowStack.c

#include "subsystem.h"

NTSTATUS PoolDriverFreePoolPrimitive(PVOID UserBuffer)
{
    NTSTATUS Status = STATUS_SUCCESS;
    long long* address;

    __try
    {
        ProbeForRead(UserBuffer, (SIZE_T)8, (ULONG)__alignof(UCHAR));

        address = *(long long*)UserBuffer;
        DbgPrint("%s User-provided Pool Address: 0x%p", PREFIX, (long long*)address);

        DbgPrint("%s Freeing The Pool...", PREFIX);
        ExFreePoolWithTag(address, 0);
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        Status = GetExceptionCode();
        DbgPrint("%s Exception Thrown! NTSTATUS: %d (0x%x)\n", PREFIX, Status, Status);
    }
 
    DbgPrint("%s ***********************\n", PREFIX);
    return Status;
}

NTSTATUS PoolDriverPrimitiveSetup(PIRP Irp, PIO_STACK_LOCATION IO)
{
    UNREFERENCED_PARAMETER(Irp);

    SIZE_T Size = 0;
    PVOID UserBuffer = 0;
    NTSTATUS Status = STATUS_INVALID_PARAMETER;

    UserBuffer = IO->Parameters.DeviceIoControl.Type3InputBuffer;
    Size = IO->Parameters.DeviceIoControl.InputBufferLength;

    if (UserBuffer)
    {
        Status = PoolDriverFreePoolPrimitive(UserBuffer);
    }

    return Status;
}