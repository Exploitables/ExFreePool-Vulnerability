// Utilized HackSys Extreme Vulnerable Driver for assistance.
// Link: https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/BufferOverflowStack.c

#include "subsystem.h"

NTSTATUS PoolDriverArbitraryWritePrimitive(PVOID UserBuffer)
{
    NTSTATUS Status = STATUS_INVALID_PARAMETER;
    WRITE_WHAT_WHERE www;

    RtlSecureZeroMemory(&www, sizeof(www));

    if (!UserBuffer)
    {
        return Status;
    }

    __try
    {
        www = *(PWRITE_WHAT_WHERE)UserBuffer;
        DbgPrint("%s User-provided Write Address: 0x%p\n%s User-provided Data: 0x%p\n%s Writing Memory...\n", PREFIX, (long long*)www.Where, PREFIX, (long long*)www.What, PREFIX);

        *(long long*)(www.Where) = www.What;
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        Status = GetExceptionCode();
        DbgPrint("%s Exception Thrown! NTSTATUS: %d (0x%x)\n", PREFIX, Status, Status);
        return Status;
    }

    Status = STATUS_SUCCESS;
    return Status;
}

NTSTATUS PoolDriverArbitraryWritePrimitiveSetup(PIRP Irp, PIO_STACK_LOCATION IO)
{
    UNREFERENCED_PARAMETER(Irp);

    PVOID UserBuffer = 0;
    NTSTATUS Status = STATUS_INVALID_PARAMETER;

    UserBuffer = IO->Parameters.DeviceIoControl.Type3InputBuffer;

    if (UserBuffer)
    {
        Status = PoolDriverArbitraryWritePrimitive(UserBuffer);
    }

    DbgPrint("%s Return NTSTATUS: %d (0x%x)\n%s ***********************\n", PREFIX, Status, Status, PREFIX);

    return Status;
}